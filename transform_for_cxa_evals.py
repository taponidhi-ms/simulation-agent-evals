#!/usr/bin/env python3
"""
CXA Evals Transformer

This script transforms conversation generator output into CXA Evals framework
input format. It reads conversations generated by the conversation_generator
module and converts them to the format expected by CXA Evals.

Usage:
    python transform_for_cxa_evals.py

Configuration:
    Edit cxa_evals_transformer/config.json to configure input/output paths
    and transformation settings.
"""

import sys
from pathlib import Path
from datetime import datetime

from cxa_evals_transformer import config
from cxa_evals_transformer.transformer import CXAEvalsTransformer


def main() -> int:
    """
    Main entry point for CXA Evals transformer.
    
    Returns:
        Exit code (0 for success, 1 for failure)
    """
    print("=" * 70)
    print("CXA Evals Transformer")
    print("=" * 70)
    print()
    
    try:
        # Create timestamped output directory
        timestamp = datetime.now().strftime("%Y%m%d_%H%M%S")
        output_dir = Path("cxa_evals_transformer/output") / f"{config.OUTPUT_FOLDER_PREFIX}{timestamp}"
        output_dir.mkdir(parents=True, exist_ok=True)
        
        # Create full output file path
        output_file = output_dir / config.OUTPUT_FILE
        
        print(f"Input directory: {config.INPUT_DIR}")
        print(f"Output directory: {output_dir}")
        print(f"Output file: {output_file}")
        print(f"Scenario name: {config.SCENARIO_NAME}")
        print(f"Task: {config.TASK}")
        print()
        
        # Create transformer
        print("-" * 50)
        print("Transforming Conversations")
        print("-" * 50)
        
        transformer = CXAEvalsTransformer(
            scenario_name=config.SCENARIO_NAME,
            task=config.TASK,
            groundness_fact=config.GROUNDNESS_FACT
        )
        
        # Transform conversations
        num_transformed = transformer.transform_directory(
            input_dir=config.INPUT_DIR,
            output_file=str(output_file)
        )
        
        print()
        print("=" * 70)
        print("Summary")
        print("=" * 70)
        print(f"Conversations transformed: {num_transformed}")
        print(f"Output saved to: {output_file}")
        print()
        
        return 0
    
    except KeyboardInterrupt:
        print("\n\nOperation cancelled by user.")
        return 1
    except Exception as e:
        print(f"\nError: {e}")
        import traceback
        traceback.print_exc()
        return 1


if __name__ == "__main__":
    sys.exit(main())
